### ══════════════════════════════════════════════════
### WebGo Backend Challenge — Test Requests
### ══════════════════════════════════════════════════
###
### Usar con la extensión "REST Client" de VS Code:
###   https://marketplace.visualstudio.com/items?itemName=humao.rest-client
###
### Prerrequisitos:
###   1. npm run dev   (inicia emuladores — terminal 1)
###   2. npm run seed  (carga datos de prueba — terminal 2)
###
### ══════════════════════════════════════════════════

@baseUrl = http://127.0.0.1:5001/demo-webgo-challenge/us-central1
@siteId = site456
@userId = user123


### ─────────────────────────────────────────────────
### 1. Crear cupón de porcentaje (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "verano2026",
    "discountType": "percentage",
    "discountValue": 15,
    "maxUses": 50,
    "minPurchase": 10000,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### 2. Crear cupón de monto fijo (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "DESCUENTO5K",
    "discountType": "fixed",
    "discountValue": 5000,
    "maxUses": 20,
    "minPurchase": 20000,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### 3. Listar cupones (getCoupons)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/getCoupons
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}"
  }
}

### ─────────────────────────────────────────────────
### 4. Actualizar cupón (updateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/updateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001",
    "discountValue": 20,
    "maxUses": 200,
    "isActive": true
  }
}

### ─────────────────────────────────────────────────
### 5. Validar cupón (validateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "BIENVENIDO",
    "cartTotal": 59990
  }
}

### ─────────────────────────────────────────────────
### 6. Validar otro cupón (validateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "NOEXISTE",
    "cartTotal": 30000
  }
}

### ─────────────────────────────────────────────────
### 7. Validar cupón variante (validateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "BIENVENIDO",
    "cartTotal": 25000
  }
}

### ─────────────────────────────────────────────────
### 8. Aplicar cupón (applyCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/applyCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001",
    "orderId": "order-test-001"
  }
}

### ─────────────────────────────────────────────────
### 9. Eliminar cupón (deleteCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/deleteCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001"
  }
}

### ─────────────────────────────────────────────────
### 10. Crear otro cupón (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "INVIERNO50",
    "discountType": "percentage",
    "discountValue": 50,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### 11. Crear cupón variante A (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "PRIMAVERA10",
    "discountType": "percentage",
    "discountValue": 10,
    "validFrom": "2026-01-01T00:00:00",
    "validUntil": "2026-12-31T23:59:59"
  }
}

### ─────────────────────────────────────────────────
### 12. Crear cupón variante B (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "MEGADESC",
    "discountType": "percentage",
    "discountValue": 150,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ══════════════════════════════════════════════════
### Validación de Reglas de Negocio
### ══════════════════════════════════════════════════

### ─────────────────────────────────────────────────
### RN1. Código único por tienda — crear código duplicado
### Esperado: error DUPLICATE_CODE
### (ejecutar después del request 1 para que VERANO2026 ya exista)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "VERANO2026",
    "discountType": "percentage",
    "discountValue": 10,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### RN2. Normalización — buscar con distinta capitalización
### Esperado: encuentra el cupón "BIENVENIDO" del seed
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "bienvenido",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### RN3. Fechas — validFrom posterior a validUntil
### Esperado: error de validación Zod
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "FECHAMAL",
    "discountType": "fixed",
    "discountValue": 1000,
    "validFrom": "2026-12-31T23:59:59-03:00",
    "validUntil": "2026-01-01T00:00:00-03:00"
  }
}

### ─────────────────────────────────────────────────
### RN5. Mínimo de compra — cartTotal menor a minPurchase
### Esperado: error MIN_PURCHASE_NOT_MET
### (ejecutar después del request 1 que crea VERANO2026 con minPurchase: 10000)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "VERANO2026",
    "cartTotal": 5000
  }
}

### ─────────────────────────────────────────────────
### RN6. Estado activo — desactivar cupón y luego validar
### Paso 1: desactivar el cupón del seed
### ─────────────────────────────────────────────────

POST {{baseUrl}}/updateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001",
    "isActive": false
  }
}

### ─────────────────────────────────────────────────
### RN6. Estado activo — validar cupón desactivado
### Esperado: error COUPON_INACTIVE
### (ejecutar después del paso anterior)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "BIENVENIDO",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### RN7. Porcentaje > 100 — ya cubierto por request 12
### Esperado: error de validación Zod "Porcentaje no puede superar 100%"
### ─────────────────────────────────────────────────

### ─────────────────────────────────────────────────
### RN8. Rango de fechas en update — solo validFrom sin validUntil
### Esperado: error si validFrom queda posterior a validUntil existente
### ─────────────────────────────────────────────────

POST {{baseUrl}}/updateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001",
    "validFrom": "2027-06-01T00:00:00-03:00"
  }
}

### ─────────────────────────────────────────────────
### Seguridad — cupón de otro sitio
### Esperado: error SITE_NOT_FOUND
### ─────────────────────────────────────────────────

POST {{baseUrl}}/getCoupons
Content-Type: application/json

{
  "data": {
    "siteId": "sitio-inexistente"
  }
}

### ─────────────────────────────────────────────────
### Seguridad — eliminar cupón con siteId incorrecto
### Esperado: error SITE_NOT_FOUND (el sitio no existe)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/deleteCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "otro-sitio",
    "couponId": "coupon001"
  }
}

### ─────────────────────────────────────────────────
### Validación — campos vacíos
### Esperado: error INVALID_INPUT
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "",
    "code": "",
    "discountType": "percentage",
    "discountValue": 10,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### Validación — discountValue negativo
### Esperado: error INVALID_INPUT
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "NEGATIVO",
    "discountType": "fixed",
    "discountValue": -500,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}
