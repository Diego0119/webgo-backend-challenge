### ══════════════════════════════════════════════════
### WebGo Backend Challenge — Test Requests
### ══════════════════════════════════════════════════
###
### Usar con la extensión "REST Client" de VS Code:
###   https://marketplace.visualstudio.com/items?itemName=humao.rest-client
###
### Prerrequisitos:
###   1. npm run dev   (inicia emuladores — terminal 1)
###   2. npm run seed  (carga datos de prueba — terminal 2)
###
### ══════════════════════════════════════════════════

@baseUrl = http://127.0.0.1:5001/demo-webgo-challenge/us-central1
@siteId = site456
@userId = user123
@siteId2 = site999
@userId2 = user789


### ─────────────────────────────────────────────────
### 1. Crear cupón de porcentaje (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "verano2026",
    "discountType": "percentage",
    "discountValue": 15,
    "maxUses": 50,
    "minPurchase": 10000,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### 2. Crear cupón de monto fijo (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "DESCUENTO5K",
    "discountType": "fixed",
    "discountValue": 5000,
    "maxUses": 20,
    "minPurchase": 20000,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### 3. Listar cupones (getCoupons)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/getCoupons
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}"
  }
}

### ─────────────────────────────────────────────────
### 4. Actualizar cupón (updateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/updateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001",
    "discountValue": 20,
    "maxUses": 200,
    "isActive": true
  }
}

### ─────────────────────────────────────────────────
### 5. Validar cupón (validateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "BIENVENIDO",
    "cartTotal": 59990
  }
}

### ─────────────────────────────────────────────────
### 6. Validar otro cupón (validateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "NOEXISTE",
    "cartTotal": 30000
  }
}

### ─────────────────────────────────────────────────
### 7. Validar cupón variante (validateCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "BIENVENIDO",
    "cartTotal": 25000
  }
}

### ─────────────────────────────────────────────────
### 8. Aplicar cupón (applyCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/applyCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001",
    "orderId": "order-test-001",
    "cartTotal": 59990
  }
}

### ─────────────────────────────────────────────────
### 9. Eliminar cupón (deleteCoupon)
### Usa coupon003 (BIENVENIDO3) para no afectar otros tests
### ─────────────────────────────────────────────────

POST {{baseUrl}}/deleteCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon003"
  }
}

### ─────────────────────────────────────────────────
### 10. Crear otro cupón (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "INVIERNO50",
    "discountType": "percentage",
    "discountValue": 50,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### 11. Crear cupón variante A (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "PRIMAVERA10",
    "discountType": "percentage",
    "discountValue": 10,
    "validFrom": "2026-01-01T00:00:00",
    "validUntil": "2026-12-31T23:59:59"
  }
}

### ─────────────────────────────────────────────────
### 12. Crear cupón variante B (createCoupon)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "MEGADESC",
    "discountType": "percentage",
    "discountValue": 150,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ══════════════════════════════════════════════════
### Validación de Reglas de Negocio
### ══════════════════════════════════════════════════

### ─────────────────────────────────────────────────
### RN1. Código único por tienda — crear código duplicado
### Esperado: error DUPLICATE_CODE
### (ejecutar después del request 1 para que VERANO2026 ya exista)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "VERANO2026",
    "discountType": "percentage",
    "discountValue": 10,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### RN2. Normalización — buscar con distinta capitalización
### Esperado: encuentra el cupón "VERANO2026" del seed
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "verano2026",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### RN3. Fechas — validFrom posterior a validUntil
### Esperado: error de validación Zod
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "FECHAMAL",
    "discountType": "fixed",
    "discountValue": 1000,
    "validFrom": "2026-12-31T23:59:59-03:00",
    "validUntil": "2026-01-01T00:00:00-03:00"
  }
}

### ─────────────────────────────────────────────────
### RN4. Validación de usos — Paso 1: crear cupón con maxUses: 1
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "UNICO",
    "discountType": "fixed",
    "discountValue": 1000,
    "maxUses": 1,
    "validFrom": "2025-01-01T00:00:00-03:00",
    "validUntil": "2027-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### RN4. Validación de usos — Paso 2: aplicar el cupón 
### (usar couponId del paso 1)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/applyCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "<USAR_CUPON_ID_ANTERIOR>",
    "orderId": "order-maxuses-001",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### RN4. Validación de usos — Paso 3: validar cupón agotado
### Esperado: error COUPON_MAX_USES
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "UNICO",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### RN5. Mínimo de compra — cartTotal menor a minPurchase
### Esperado: error MIN_PURCHASE_NOT_MET
### (ejecutar después del request 1 que crea VERANO2026 con minPurchase: 10000)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "VERANO2026",
    "cartTotal": 5000
  }
}

### ─────────────────────────────────────────────────
### RN6. Estado activo — desactivar cupón y luego validar
### Paso 1: desactivar el cupón del seed (el couponId debe
### coincidir don el id del cupón a desactivar)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/updateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "<USAR_CUPON_ID_A_DESACTIVAR>",
    "isActive": false
  }
}

### ─────────────────────────────────────────────────
### RN6. Estado activo — validar cupón desactivado
### Esperado: error COUPON_INACTIVE
### (ejecutar después del paso anterior)
### el "code", debe ser el nombre del cupón desactivado
### anteriormente
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "<NOMBRE_DEL_CUPON_DESACTIVADO>",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### RN7. Porcentaje > 100 — ya cubierto por request 12
### Esperado: error de validación Zod "Porcentaje no puede superar 100%"
### ─────────────────────────────────────────────────

### ─────────────────────────────────────────────────
### RN8. Rango de fechas en update — solo validFrom sin validUntil
### Esperado: error si validFrom queda posterior a validUntil existente
### ─────────────────────────────────────────────────

POST {{baseUrl}}/updateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon001",
    "validFrom": "2027-06-01T00:00:00-03:00"
  }
}

### ─────────────────────────────────────────────────
### Seguridad — cupón de otro sitio
### Esperado: error SITE_NOT_FOUND
### ─────────────────────────────────────────────────

POST {{baseUrl}}/getCoupons
Content-Type: application/json

{
  "data": {
    "siteId": "sitio-inexistente"
  }
}

### ─────────────────────────────────────────────────
### Seguridad — eliminar cupón con siteId incorrecto
### Esperado: error SITE_NOT_FOUND (el sitio no existe)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/deleteCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "otro-sitio",
    "couponId": "coupon001"
  }
}

### ─────────────────────────────────────────────────
### Validación — campos vacíos
### Esperado: error INVALID_INPUT
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "",
    "code": "",
    "discountType": "percentage",
    "discountValue": 10,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### Validación — discountValue negativo
### Esperado: error INVALID_INPUT
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "code": "NEGATIVO",
    "discountType": "fixed",
    "discountValue": -500,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ══════════════════════════════════════════════════
### Aislamiento Multi-Tenant (site999 — user789, plan free)
### ══════════════════════════════════════════════════

### ─────────────────────────────────────────────────
### MT1. Listar cupones de site2
### Esperado: solo coupon002 (BIENVENIDO $5,000 fixed)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/getCoupons
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}"
  }
}

### ─────────────────────────────────────────────────
### MT2. Mismo código "BIENVENIDO" en site2 — debe ser distinto al de site1
### Esperado: valid: true, discountType: "fixed", discountAmount: 5000
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "code": "BIENVENIDO",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### MT3. Aplicar cupón de site2 con cartTotal
### Esperado: discountAmount: 5000, finalTotal: 45000, usedCount: 1
### ─────────────────────────────────────────────────

POST {{baseUrl}}/applyCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "couponId": "coupon002",
    "orderId": "order-site2-001",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### MT4. Aplicar cupón de site2 pero enviando siteId de site1
### Esperado: error FORBIDDEN (el cupón no pertenece a site456)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/applyCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId}}",
    "couponId": "coupon002",
    "orderId": "order-cross-001",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### MT5. Actualizar cupón de site1 usando siteId de site2
### Esperado: error FORBIDDEN
### ─────────────────────────────────────────────────

POST {{baseUrl}}/updateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "couponId": "coupon001",
    "discountValue": 99
  }
}

### ─────────────────────────────────────────────────
### MT6. Eliminar cupón de site1 usando siteId de site2
### Esperado: error FORBIDDEN
### ─────────────────────────────────────────────────

POST {{baseUrl}}/deleteCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "couponId": "coupon001"
  }
}

### ─────────────────────────────────────────────────
### MT7. minPurchase en applyCoupon — coupon002 requiere $20,000
### Esperado: error MIN_PURCHASE_NOT_MET
### ─────────────────────────────────────────────────

POST {{baseUrl}}/applyCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "couponId": "coupon002",
    "orderId": "order-minpurchase-001",
    "cartTotal": 10000
  }
}

### ─────────────────────────────────────────────────
### MT8. Crear cupón en site2 (1 de 3 permitidos en plan free)
### Esperado: éxito
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "code": "FREECUPON1",
    "discountType": "percentage",
    "discountValue": 5,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### MT9. Crear segundo cupón en site2 (2 de 3)
### Esperado: éxito
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "code": "FREECUPON2",
    "discountType": "fixed",
    "discountValue": 2000,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### MT10. Crear tercer cupón en site2 — EXCEDE límite plan free (3/3)
### Esperado: error COUPON_LIMIT_REACHED
### (coupon002 del seed + MT8 + MT9 = 3 cupones, ya al límite)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/createCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "code": "FREECUPON3",
    "discountType": "percentage",
    "discountValue": 10,
    "validFrom": "2026-01-01T00:00:00-03:00",
    "validUntil": "2026-12-31T23:59:59-03:00"
  }
}

### ─────────────────────────────────────────────────
### MT11. Descuento fijo mayor al carrito — cap al total
### Esperado: discountAmount: 5000 (capped a cartTotal no aplica aquí,
### pero finalTotal: 0 porque Math.max(25000 - 5000, 0) = 20000)
### Usamos cartTotal que cumple minPurchase ($20,000) de coupon002
### Para probar cap real, usamos FREECUPON2 ($2,000 fijo, sin minPurchase)
### con un cart de $1,000 → discountAmount: 1000, finalTotal: 0
### (ejecutar después de MT9 para que FREECUPON2 exista)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "code": "FREECUPON2",
    "cartTotal": 1000
  }
}

### ─────────────────────────────────────────────────
### MT12. validateCoupon en site2 con sitio inexistente
### Esperado: error SITE_NOT_FOUND
### ─────────────────────────────────────────────────

POST {{baseUrl}}/validateCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "sitio-fantasma",
    "code": "BIENVENIDO",
    "cartTotal": 50000
  }
}

### ─────────────────────────────────────────────────
### MT13. applyCoupon sin cartTotal
### Esperado: error INVALID_INPUT (cartTotal: Required)
### ─────────────────────────────────────────────────

POST {{baseUrl}}/applyCoupon
Content-Type: application/json

{
  "data": {
    "siteId": "{{siteId2}}",
    "couponId": "coupon002",
    "orderId": "order-nocart-001"
  }
}
